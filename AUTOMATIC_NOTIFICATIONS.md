# 자동 알림 시스템 가이드

## ✅ 시스템을 꺼도 알림이 자동으로 옵니다!

현재 시스템은 **Vercel Cron Jobs**를 사용하여 자동으로 알림을 보냅니다.

## 🕐 알림 실행 시간

**매일 오전 9시 (한국 시간 기준)**에 자동으로 실행됩니다.

- 설정 파일: `vercel.json`
- 스케줄: `0 9 * * *` (매일 오전 9시)
- 실행 엔드포인트: `/api/cron/check-notifications`

## 🔔 알림 작동 방식

### 1. 자동 실행
- Vercel 서버에서 매일 오전 9시에 자동 실행
- **컴퓨터를 꺼도 작동합니다** (Vercel 서버에서 실행)
- 인터넷 연결만 있으면 됩니다

### 2. 알림 체크 과정
1. 모든 활성 사용자 조회 (Slack Webhook 설정 + 알림 활성화)
2. 각 사용자의 구독 정보 확인
3. 설정된 알림 시점과 일치하는 구독 찾기
4. Slack으로 알림 전송
5. 알림 히스토리 저장 (중복 방지)

### 3. 여러 알림 시점 지원
- 예: 7일 전, 3일 전, 1일 전에 각각 알림
- 설정 방법: Slack 설정 > 알림 시점 설정에서 추가

## 📋 알림이 작동하려면

### 필수 조건
1. ✅ **Slack Webhook URL 설정**
   - Slack 설정에서 Webhook URL 저장

2. ✅ **알림 활성화**
   - Slack Webhook 저장 시 자동 활성화

3. ✅ **구독 정보 등록**
   - 결제 알림 텍스트 분석하여 구독 추가

4. ✅ **다음 결제일 설정**
   - 정확한 결제일이 설정되어 있어야 함

### 알림 시점 설정
- 기본값: 결제일 3일 전
- 커스터마이징: Slack 설정 > 알림 시점 설정에서 변경
- 여러 시점 가능: 예) 7일 전, 3일 전, 1일 전

## 🧪 테스트 방법

### 1. 수동 테스트
브라우저나 curl로 직접 호출:
```bash
curl https://subscribe-handler.vercel.app/api/cron/check-notifications
```

또는 브라우저에서:
```
https://subscribe-handler.vercel.app/api/cron/check-notifications
```

### 2. Slack 알림 테스트
- Slack 설정에서 "알림 테스트" 버튼 클릭
- 즉시 테스트 메시지 전송

### 3. 실제 알림 확인
- 다음 결제일이 설정된 알림 시점과 일치하는 구독이 있는지 확인
- 매일 오전 9시에 자동 실행되므로, 그 시간에 맞춰 확인

## 📊 Cron Job 실행 확인

### Vercel 대시보드에서 확인
1. [Vercel Dashboard](https://vercel.com/dashboard) 접속
2. 프로젝트 선택
3. **Cron Jobs** 탭 클릭
4. 실행 이력 확인:
   - ✅ 성공: 초록색 체크
   - ❌ 실패: 빨간색 X (로그 확인)

### 실행 로그 확인
Vercel 대시보드 > 프로젝트 > **Deployments** > 최신 배포 > **Functions** 탭에서 로그 확인

## ⚙️ 알림 시간 변경하기

`vercel.json` 파일에서 스케줄 변경:

```json
{
  "crons": [
    {
      "path": "/api/cron/check-notifications",
      "schedule": "0 9 * * *"  // 여기 변경
    }
  ]
}
```

### 스케줄 형식 (Cron)
- `0 9 * * *` = 매일 오전 9시
- `0 8 * * *` = 매일 오전 8시
- `0 9 * * 1` = 매주 월요일 오전 9시
- `0 */6 * * *` = 6시간마다

변경 후 Git에 커밋하고 푸시하면 자동 반영됩니다.

## 🔒 보안

### CRON_SECRET 설정 (선택사항)
무단 접근을 방지하려면:

1. Vercel 환경 변수에 `CRON_SECRET` 추가
2. 랜덤 문자열 설정 (예: `my-secret-key-12345`)

설정하면 Cron Job만 실행할 수 있습니다.

## ❓ 문제 해결

### 알림이 오지 않아요

1. **Slack Webhook 확인**
   - Slack 설정에서 Webhook URL이 올바른지 확인
   - "알림 테스트" 버튼으로 테스트

2. **알림 활성화 확인**
   - Slack 설정에서 알림이 활성화되어 있는지 확인

3. **구독 정보 확인**
   - 다음 결제일이 올바르게 설정되어 있는지 확인
   - 알림 시점과 일치하는지 확인 (예: 3일 전 설정이면 결제일 3일 전에 알림)

4. **Cron Job 실행 확인**
   - Vercel 대시보드에서 Cron Job이 실행되었는지 확인
   - 실행 로그에서 오류 확인

5. **알림 히스토리 확인**
   - 같은 날짜, 같은 시점에 이미 알림을 보냈으면 중복 방지로 스킵됨

### Cron Job이 실행되지 않아요

1. **Vercel 배포 확인**
   - 최신 코드가 배포되었는지 확인
   - `vercel.json` 파일이 포함되어 있는지 확인

2. **환경 변수 확인**
   - Supabase 환경 변수가 설정되어 있는지 확인

3. **Vercel 무료 티어 제한**
   - 무료 티어에서도 Cron Jobs는 작동합니다
   - 단, 일일 실행 횟수 제한이 있을 수 있습니다

## 📝 요약

✅ **시스템을 꺼도 알림이 옵니다**
- Vercel 서버에서 자동 실행
- 매일 오전 9시에 자동 체크
- 설정만 완료하면 자동 작동

✅ **필요한 설정**
1. Slack Webhook URL 저장
2. 구독 정보 등록
3. 알림 시점 설정 (선택사항)

✅ **확인 방법**
- Vercel 대시보드 > Cron Jobs 탭
- Slack에서 알림 수신 확인

